<!DOCTYPE html>
<html>
<head>
  <title>Urban Analysis GIS</title>
  <meta name="viewport" charset="utf-8" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="urban/plugin/L.Control.Sidebar.css" />
  <script src="urban/plugin/L.Control.Sidebar.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css" />
<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
<link rel="stylesheet" href="urban/plugin/style.css" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
/>

<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="urban/plugin/L.Control.MousePosition.js"></script>
<link rel="stylesheet" href="urban/plugin/L.Control.MousePosition.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<link
href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
rel="stylesheet"
>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>


</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">

    <a class="navbar-brand text-white" href="#" onclick="location.reload();" title="Click to reload the dashboard" style="justify-content: center;display: flex;align-items: center; width: 100%; text-wrap: inherit;">
      <i class="fas fa-globe-africa me-2"></i>
      Urban Analysis GIS
   
    </a>
    
  </nav>

<div id="map"></div>
<div id="side-bar" style="background-color: #f1f1f1">
    <a href="javascript:void(0)" class="closebtn" onclick="sidebarreturn()"
        >&times;</a
    >
    <br>
    <div class="sidebar-content">
      <h2>Urban Analysis GIS</h2>
      <p>
      This interactive web-based GIS application demonstrates advanced urban spatial analysis techniques.
      It allows users to explore and analyze key points of interest (POIs) across Tunisia, including Health, Security, Energy, Transportation, and Administration facilities.
      </p>
      <p>
      Key features include:
      <ul>
        <li><b>Nearest Analysis:</b> Quickly identify the closest POI in each category from any location on the map.</li>
        <li><b>Nearby Analysis:</b> Explore all POIs within a selectable radius and view counts per category.</li>
        <li><b>Category Heatmaps:</b> Visualize density patterns of different POI types to understand urban distribution.</li>
        <li><b>Search:</b> Easily find POIs by name across all categories with instant map zoom and highlighting.</li>
        <li><b>Interactive Mapping:</b> Smooth mobile-friendly map experience with clustering, popups, and real-time analysis.</li>
      </ul>
      </p>
      <!-- <p>
      This app showcases skills in GIS development, web mapping, spatial analysis, and data visualization, combining <b>Leaflet.js</b>, <b>Turf.js</b>, and modern web technologies for an intuitive and responsive urban planning tool.
      </p> -->
    
    </div>
    
</div>


  

  <script>
    // 1. Create map
    // const map = L.map('map').setView([34.0, 9.0], 6); // center Tunisia

const map = L.map('map', {
  center: [34.0, 9.0],
  zoom: 6,
  zoomControl: false  // disable default top-left zoom
});

    const topoesri = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
  {
    attribution: 'Tiles © Esri',
    maxZoom: 19
  }
).addTo(map);
// OpenStreetMap
const osm = L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 19
  }
);

// Esri Satellite Imagery
const esriSat = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/' +
  'World_Imagery/MapServer/tile/{z}/{y}/{x}',
  {
    attribution: 'Tiles © Esri',
    maxZoom: 19
  }
);


const allPOIs = [];
let analysisMode = null;
let analysisLayer = L.layerGroup().addTo(map);
let clickMarker = null;

let nearbyRadius = 500; // default in meters

const categoryStyles = {
  health:   { color: '#e63946' },
  security:{ color: '#457b9d' },
  energy:  { color: '#f4a261' },
  transport:{ color: '#2a9d8f' },
  admin:   { color: '#6a4c93' }
};

const categoryLabels = {
  health: 'Health',
  security: 'Security',
  energy: 'Energy',
  transport: 'Transport',
  admin: 'Administration'
};
let heatmapLayer = null;
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////// ADD GEOJSON DATA /////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////

const adminIcon = L.icon({
  iconUrl: 'urban/icons/public-administration.png',   // your icon
  iconSize: [30, 30],
  iconAnchor: [15, 30],
  popupAnchor: [0, -25]
});
const clusterGroupadmin = L.markerClusterGroup({
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: true,
  maxClusterRadius: 50
});
/////
const securityIcon = L.icon({
  iconUrl: 'urban/icons/poisecurity.png',   // your icon
  iconSize: [30, 30],
  iconAnchor: [15, 30],
  popupAnchor: [0, -25]
});
const clusterGroupsecurity = L.markerClusterGroup({
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: true,
  maxClusterRadius: 50
});
/////
const transportIcon = L.icon({
  iconUrl: 'urban/icons/transportation.png',   // your icon
  iconSize: [30, 30],
  iconAnchor: [15, 30],
  popupAnchor: [0, -25]
});
const clusterGrouptransport = L.markerClusterGroup({
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: true,
  maxClusterRadius: 50
});
/////
const healthIcon = L.icon({
  iconUrl: 'urban/icons/red-cross.png',   // your icon
  iconSize: [30, 30],
  iconAnchor: [15, 30],
  popupAnchor: [0, -25]
});
const clusterGrouphealth = L.markerClusterGroup({
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: true,
  maxClusterRadius: 50
});
/////
const energyIcon = L.icon({
  iconUrl: 'urban/icons/gas-pump.png',   // your icon
  iconSize: [30, 30],
  iconAnchor: [15, 30],
  popupAnchor: [0, -25]
});
const clusterGroupenergy = L.markerClusterGroup({
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: true,
  maxClusterRadius: 50
});

    // 3. Load your GeoJSON
  fetch('urban/data/admin.geojson')
  .then(res => res.json())
  .then(data => {

    const poiadmin = L.geoJSON(data, {
      pointToLayer: function (feature, latlng) {
        const marker = L.marker(latlng, { icon: adminIcon });

    allPOIs.push({
      layer: marker,
      latlng: latlng,
      category: 'admin',
      properties: feature.properties
    });

    return marker;
  },
      //   return L.marker(latlng, { icon: adminIcon });
      // },

      onEachFeature: function (feature, layer) {
        layer.bindPopup(`
          <b>Nom :</b> ${feature.properties.Name_POI_F || '—'}<br>
          <b>Description :</b> ${feature.properties.Valeur_POI || '—'}
        `);
      }
    });

    clusterGroupadmin.addLayer(poiadmin);
    map.addLayer(clusterGroupadmin);
  });
/////
fetch('urban/data/energy.geojson')
  .then(res => res.json())
  .then(data => {

    const poienergy = L.geoJSON(data, {
      pointToLayer: function (feature, latlng) {
      //   return L.marker(latlng, { icon: energyIcon });
      // },
      const marker = L.marker(latlng, { icon: energyIcon });

allPOIs.push({
  layer: marker,
  latlng: latlng,
  category: 'energy',
  properties: feature.properties
});

return marker;
},
      onEachFeature: function (feature, layer) {
        layer.bindPopup(`
          <b>Nom :</b> ${feature.properties.Name_POI_F || '—'}<br>
          <b>Description :</b> ${feature.properties.Valeur_POI || '—'}
        `);
      }
    });

    clusterGroupenergy.addLayer(poienergy);
    map.addLayer(clusterGroupenergy);
  });
/////
fetch('urban/data/health.geojson')
  .then(res => res.json())
  .then(data => {

    const poihealth = L.geoJSON(data, {
      pointToLayer: function (feature, latlng) {
      //   return L.marker(latlng, { icon: healthIcon });
      // },
      const marker = L.marker(latlng, { icon: healthIcon });

allPOIs.push({
  layer: marker,
  latlng: latlng,
  category: 'health',
  properties: feature.properties
});

return marker;
},

      onEachFeature: function (feature, layer) {
        layer.bindPopup(`
          <b>Nom :</b> ${feature.properties.Name_POI_F || '—'}<br>
          <b>Description :</b> ${feature.properties.Valeur_POI || '—'}
        `);
      }
    });

    clusterGrouphealth.addLayer(poihealth);
    map.addLayer(clusterGrouphealth);
  });
/////
fetch('urban/data/security.geojson')
  .then(res => res.json())
  .then(data => {

    const poisecurity = L.geoJSON(data, {
      pointToLayer: function (feature, latlng) {
      //   return L.marker(latlng, { icon: securityIcon });
      // },
      const marker = L.marker(latlng, { icon: securityIcon });

allPOIs.push({
  layer: marker,
  latlng: latlng,
  category: 'security',
  properties: feature.properties
});

return marker;
},

      onEachFeature: function (feature, layer) {
        layer.bindPopup(`
          <b>Nom :</b> ${feature.properties.Name_POI_F || '—'}<br>
          <b>Description :</b> ${feature.properties.Valeur_POI || '—'}
        `);
      }
    });

    clusterGroupsecurity.addLayer(poisecurity);
    map.addLayer(clusterGroupsecurity);
  });
/////
fetch('urban/data/transport.geojson')
  .then(res => res.json())
  .then(data => {

    const poitransport = L.geoJSON(data, {
      pointToLayer: function (feature, latlng) {
      //   return L.marker(latlng, { icon: transportIcon });
      // },
      const marker = L.marker(latlng, { icon: transportIcon });

allPOIs.push({
  layer: marker,
  latlng: latlng,
  category: 'transport',
  properties: feature.properties
});

return marker;
},

      onEachFeature: function (feature, layer) {
        layer.bindPopup(`
          <b>Nom :</b> ${feature.properties.Name_POI_F || '—'}<br>
          <b>Description :</b> ${feature.properties.Valeur_POI || '—'}
        `);
      }
    });

    clusterGrouptransport.addLayer(poitransport);
    map.addLayer(clusterGrouptransport);
  });



//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////// BASE MAPS/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////

const baseMaps = {
  "OpenStreetMap": osm,
  "Esri Satellite": esriSat,
  "Esri Topographie":topoesri
};

const overlayMaps = {
  "Health": clusterGrouphealth,
  "Security": clusterGroupsecurity,
  "Energy": clusterGroupenergy,
  "Transportation": clusterGrouptransport,
  "Administration": clusterGroupadmin
};




  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////// ADD EASY-BUTTONS /////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
L.control.zoom({
  position: 'topleft'
}).addTo(map);

function sidebarreturn() {
				ctlSidebar.toggle();
			}
			ctlSidebar = L.control.sidebar("side-bar").addTo(map);
			ctlEasybutton = L.easyButton("fa fa-bars", function () {
				ctlSidebar.toggle();
			})
				.setPosition("topleft")
				.addTo(map);

L.easyButton({
    position: 'topleft',       // top right corner
    states: [{
        stateName: 'go-to-page',
        icon: 'fa-refresh',  // font awesome icon
        title: 'Return to previous page',
        onClick: function(btn, map){
            window.location.href = './index.html'; // redirect
        }
    }]
}).addTo(map);

L.control.mousePosition({ position: "bottomleft", prefix: "Lat : Long" }).addTo(map);

L.control.layers(baseMaps, overlayMaps, {
  collapsed: true,
  position: 'bottomleft'
}).addTo(map);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////// Analysis /////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////
const radiusControl = L.control({ position: 'bottomright' });

radiusControl.onAdd = function () {
  const div = L.DomUtil.create('div', 'radius-control');

  div.innerHTML = `
    <label><b>Nearby radius</b></label>
    <select id="radiusSelect" class="form-select form-select-sm">
      <option value="500">500 m</option>
      <option value="1000">1 km</option>
      <option value="2000">2 km</option>
      <option value="10000">10 km</option>
      <option value="50000">50 km</option>
    </select>
  `;

  // prevent map drag when interacting
  L.DomEvent.disableClickPropagation(div);

  return div;
};


L.easyButton({
  position: 'bottomright',
  states: [{
    stateName: 'nearest',
    icon: 'fa-location-crosshairs',
    title: 'Nearest POI',
    onClick: function () {
      analysisMode = 'nearest';
      clearAnalysis();
      map.removeControl(radiusControl);
      showToast('Nearest POI mode activated, click on map!');
    }
  }]
}).addTo(map);

L.easyButton({
  position: 'bottomright',
  states: [{
    stateName: 'nearby',
    icon: 'fa-circle-dot',
    title: 'Nearby POIs',
    onClick: function () {
      analysisMode = 'nearby';
      clearAnalysis();
      radiusControl.addTo(map);
      showToast('Nearby POIs mode activated, click on map!');
    }
  }]
}).addTo(map);

L.easyButton({
  position: 'bottomright',
  states: [{
    stateName: 'clear',
    icon: 'fa-xmark',
    title: 'Clear analysis',
    onClick: function () {
      analysisMode = null;
      clearAnalysis();
      map.removeControl(radiusControl);
      showToast('Analysis cleared');
    }
  }]
}).addTo(map);

function clearAnalysis() {
  analysisLayer.clearLayers();
  if (clickMarker) {
    map.removeLayer(clickMarker);
    clickMarker = null;
  }
}

function showToast(message) {
  const toast = L.control({ position: 'bottomleft' });

  toast.onAdd = function () {
    const div = L.DomUtil.create('div', 'map-toast');
    div.innerHTML = message;
    return div;
  };

  toast.addTo(map);

  setTimeout(() => {
    map.removeControl(toast);
  }, 6000);
}


// map.on('click', function (e) {
//   runNearestAnalysis(e.latlng);
// });
map.on('click', function (e) {

if (!analysisMode) return;

if (analysisMode === 'nearest') {
  runNearestAnalysis(e.latlng);
}

if (analysisMode === 'nearby') {
  runNearbyAnalysis(e.latlng);
}
});


// function runNearestAnalysis(clickLatLng) {
//   analysisLayer.clearLayers();

//   clickMarker = L.circleMarker(clickLatLng, {
//     radius: 6,
//     color: '#000',
//     fillColor: '#fff',
//     fillOpacity: 1
//   }).addTo(analysisLayer);

//   let nearest = null;
//   let minDistance = Infinity;

//   allPOIs.forEach(poi => {
//     const d = clickLatLng.distanceTo(poi.latlng);
//     if (d < minDistance) {
//       minDistance = d;
//       nearest = poi;
//     }
//   });

//   if (!nearest) return;

//   // line
//   L.polyline([clickLatLng, nearest.latlng], {
//     color: 'red',
//     weight: 3
//   }).addTo(analysisLayer);

//   // highlight POI
//   L.circleMarker(nearest.latlng, {
//     radius: 8,
//     color: 'red',
//     fillOpacity: 0.8
//   }).addTo(analysisLayer)
//     .bindPopup(`
//       <b>Nearest POI</b><br>
//       ${nearest.properties.Name_POI_F || '—'}<br>
//       Distance: ${(minDistance / 1000).toFixed(2)} km
//     `)
//     .openPopup();
// }

function runNearestAnalysis(clickLatLng) {
  analysisLayer.clearLayers();

  clickMarker = L.circleMarker(clickLatLng, {
    radius: 6,
    color: '#000',
    fillColor: '#fff',
    fillOpacity: 1
  }).addTo(analysisLayer);

  const byCategory = {};
  const distanceInfo = [];

  // group POIs by category
  allPOIs.forEach(poi => {
    if (!byCategory[poi.category]) {
      byCategory[poi.category] = [];
    }
    byCategory[poi.category].push(poi);
  });

  Object.keys(byCategory).forEach(category => {
    let nearest = null;
    let minDistance = Infinity;

    byCategory[category].forEach(poi => {
      const d = clickLatLng.distanceTo(poi.latlng);
      if (d < minDistance) {
        minDistance = d;
        nearest = poi;
      }
    });

    if (!nearest) return;

    // draw line
    L.polyline(
      [clickLatLng, nearest.latlng],
      {
        color: categoryStyles[category]?.color || '#333',
        weight: 3,
        dashArray: '5,5'
      }
    ).addTo(analysisLayer);

    // highlight nearest POI
    L.circleMarker(nearest.latlng, {
      radius: 7,
      color: categoryStyles[category]?.color || '#333',
      fillOpacity: 0.9
    }).addTo(analysisLayer);

    // store distance info
    distanceInfo.push({
      category: category,
      distance: minDistance
    });
  });

  // build popup content
  let popupHtml = `<b>Nearest POIs</b><br><hr style="margin:4px 0">`;

  distanceInfo.forEach(d => {
    popupHtml += `
      <span style="color:${categoryStyles[d.category]?.color}">
        ● ${categoryLabels[d.category] || d.category}
      </span> :
      ${(d.distance / 1000).toFixed(2)} km<br>
    `;
  });

  clickMarker.bindPopup(popupHtml).openPopup();
}


// function runNearbyAnalysis(clickLatLng) {
//   analysisLayer.clearLayers();
//   const select = document.getElementById('radiusSelect');
// if (select) nearbyRadius = parseInt(select.value);

//   const radius = 50000; // meters

//   clickMarker = L.circleMarker(clickLatLng, {
//     radius: 6,
//     color: '#000',
//     fillColor: '#fff',
//     fillOpacity: 1
//   }).addTo(analysisLayer);

//   const buffer = L.circle(clickLatLng, {
//     radius: radius,
//     color: 'blue',
//     fillOpacity: 0.1
//   }).addTo(analysisLayer);

//   let count = 0;

//   allPOIs.forEach(poi => {
//     const d = clickLatLng.distanceTo(poi.latlng);
//     if (d <= radius) {
//       count++;

//       L.circleMarker(poi.latlng, {
//         radius: 6,
//         color: 'blue',
//         fillOpacity: 0.8
//       }).addTo(analysisLayer);
//     }
//   });

//   buffer.bindPopup(`
//     <b>Nearby POIs</b><br>
//     Radius: ${radius} m<br>
//     Found: ${count}
//   `).openPopup();
// }

// function runNearbyAnalysis(clickLatLng) {
//   analysisLayer.clearLayers();

//   const select = document.getElementById('radiusSelect');
//   if (select) nearbyRadius = parseInt(select.value);

//   clickMarker = L.circleMarker(clickLatLng, {
//     radius: 6,
//     color: '#000',
//     fillColor: '#fff',
//     fillOpacity: 1
//   }).addTo(analysisLayer);

//   const buffer = L.circle(clickLatLng, {
//     radius: nearbyRadius,
//     color: 'blue',
//     fillOpacity: 0.1
//   }).addTo(analysisLayer);

//   let count = 0;

//   allPOIs.forEach(poi => {
//     const d = clickLatLng.distanceTo(poi.latlng);
//     if (d <= nearbyRadius) {
//       count++;

//       L.circleMarker(poi.latlng, {
//         radius: 6,
//         color: 'blue',
//         fillOpacity: 0.8
//       }).addTo(analysisLayer);
//     }
//   });

//   buffer.bindPopup(`
//     <b>Nearby POIs</b><br>
//     Radius: ${nearbyRadius} m<br>
//     Found: ${count}
//   `).openPopup();
// }

function runNearbyAnalysis(clickLatLng) {
  analysisLayer.clearLayers();

  const select = document.getElementById('radiusSelect');
  if (select) nearbyRadius = parseInt(select.value);

  clickMarker = L.circleMarker(clickLatLng, {
    radius: 6,
    color: '#000',
    fillColor: '#fff',
    fillOpacity: 1
  }).addTo(analysisLayer);

  // draw buffer
  const buffer = L.circle(clickLatLng, {
    radius: nearbyRadius,
    color: '#444',
    fillOpacity: 0.1
  }).addTo(analysisLayer);

  // initialize counters
  const counts = {};

  allPOIs.forEach(poi => {
    const d = clickLatLng.distanceTo(poi.latlng);

    if (d <= nearbyRadius) {

      // count per category
      if (!counts[poi.category]) {
        counts[poi.category] = 0;
      }
      counts[poi.category]++;

      // highlight POI
      L.circleMarker(poi.latlng, {
        radius: 6,
        color: categoryStyles[poi.category]?.color || '#333',
        fillOpacity: 0.8
      }).addTo(analysisLayer);
    }
  });

  // build popup content
  let popupHtml = `
    <b>Nearby POIs</b><br>
    Radius: ${(nearbyRadius / 1000).toFixed(1)} km
    <hr style="margin:4px 0">
  `;

  Object.keys(categoryStyles).forEach(cat => {
    const count = counts[cat] || 0;

    popupHtml += `
      <span style="color:${categoryStyles[cat].color}">
        ● ${categoryLabels[cat] || cat}
      </span> : ${count}<br>
    `;
  });

  clickMarker.bindPopup(popupHtml).openPopup();
}

///////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////// SEARCH BAR ////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////
const searchControl = L.control({ position: 'topright' });

searchControl.onAdd = function () {
  const div = L.DomUtil.create('div', 'search-control');

  div.innerHTML = `
    <input 
      type="text" 
      id="searchInput" 
      class="form-control form-control-sm"
      placeholder="Search POIs..."
    />
    <div id="searchResults"></div>
  `;

  L.DomEvent.disableClickPropagation(div);

  return div;
};

searchControl.addTo(map);

/////////////////////////////

const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');

searchInput.addEventListener('input', function () {
  const query = this.value.toLowerCase();
  searchResults.innerHTML = '';

  if (query.length < 2) return;

  const matches = allPOIs.filter(poi => {
    const name = poi.properties.Name_POI_F || '';
    return name.toLowerCase().includes(query);
  });

  matches.slice(0, 20).forEach(poi => {
    const div = document.createElement('div');
    div.className = 'search-item';
    div.innerHTML = `
      <span style="color:${categoryStyles[poi.category]?.color}">
        ● ${categoryLabels[poi.category]}
      </span><br>
      <small>${poi.properties.Name_POI_F}</small>
    `;

    div.onclick = function () {
      zoomToPOI(poi);
    };

    searchResults.appendChild(div);
  });
});
//////////////////////////////

function zoomToPOI(poi) {
  clearAnalysis();
  searchResults.innerHTML = '';
  searchInput.value = '';

  map.setView(poi.latlng, 19);

  const highlight = L.circleMarker(poi.latlng, {
    radius: 10,
    color: categoryStyles[poi.category]?.color || '#000',
    fillOpacity: 0.9
  }).addTo(analysisLayer);

  setTimeout(() => {
    analysisLayer.removeLayer(highlight);
  }, 3000);

  poi.layer.openPopup();
}

/////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////// HEAT MAP ///////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////

const heatmapControl = L.control({ position: 'topright' });

heatmapControl.onAdd = function () {
  const div = L.DomUtil.create('div', 'heatmap-control');
  div.innerHTML = `
    <label><b>Heatmap category</b></label>
    <select id="heatmapSelect" class="form-select form-select-sm">
      <option value="">-- None --</option>
      <option value="health">Health</option>
      <option value="security">Security</option>
      <option value="energy">Energy</option>
      <option value="transport">Transport</option>
      <option value="admin">Administration</option>
    </select>
  `;
  L.DomEvent.disableClickPropagation(div);
  return div;
};

heatmapControl.addTo(map);
////////////////////////////////

document.getElementById('heatmapSelect').addEventListener('change', function () {
  const category = this.value;

  // remove old heatmap if exists
  if (heatmapLayer) {
    map.removeLayer(heatmapLayer);
    heatmapLayer = null;
  }

  if (!category) return; // None selected

  // get latlngs of POIs in this category
  const points = allPOIs
    .filter(poi => poi.category === category)
    .map(poi => [poi.latlng.lat, poi.latlng.lng, 15]); // last value = intensity

  if (points.length === 0) return;

  heatmapLayer = L.heatLayer(points, {
  radius: map.getZoom() * 2 + 10, // increases radius when zooming out
  blur: 20,
  maxZoom: 17,
  gradient: {
    0.2: '#2a9d8f',
    0.4: '#f4a261',
    0.6: '#e76f51',
    0.8: '#e63946',
    1.0: '#d62828'
  }
}).addTo(map);

});



  </script>
</body>
</html>














